# エッジケースとバグ修正

## 確認済みのエッジケース

### 1. 投稿関連

#### 1.1 活動日時のエッジケース
- ✅ **実装済み**: 活動日時が未来であることをチェック
- ✅ **実装済み**: 終了日時が開始日時より後であることをチェック
- ⚠️ **確認が必要**: タイムゾーンの扱い（現在はサーバーのタイムゾーンを使用）

#### 1.2 募集人数のエッジケース
- ✅ **実装済み**: 最小値（1人）と最大値（100人）のチェック
- ✅ **実装済み**: 現在の参加者数が最大人数を超えないことをチェック
- ✅ **実装済み**: 満員の場合、投稿ステータスを「closed」に更新

#### 1.3 投稿ステータスのエッジケース
- ✅ **実装済み**: 論理削除（`deletedAt` が設定される）
- ✅ **実装済み**: 削除された投稿は一覧に表示されない
- ⚠️ **確認が必要**: 削除された投稿の詳細ページへのアクセス（現在は404を返す）

### 2. 応募関連

#### 2.1 応募の重複チェック
- ✅ **実装済み**: 同じ投稿に複数の「pending」または「approved」の応募を作成できない
- ✅ **実装済み**: キャンセル済みの応募は再応募可能

#### 2.2 応募ステータスの更新
- ✅ **実装済み**: 承認時に参加者数を更新
- ✅ **実装済み**: 承認時に投稿ステータスを更新（満員の場合）
- ✅ **実装済み**: キャンセル時に参加者数を更新
- ✅ **実装済み**: キャンセル時に投稿ステータスを更新（満員でなくなった場合）

#### 2.3 応募の権限チェック
- ✅ **実装済み**: 自分の投稿には応募できない
- ✅ **実装済み**: 募集終了の投稿には応募できない
- ✅ **実装済み**: 満員の投稿には応募できない

### 3. チャット関連

#### 3.1 チャットメッセージの権限チェック
- ✅ **実装済み**: 承認済みの応募のみメッセージを送信可能
- ✅ **実装済み**: 送信者と受信者のチェック
- ✅ **実装済み**: 応募の関係者（投稿者または応募者）のみアクセス可能

#### 3.2 チャットルームの取得
- ✅ **実装済み**: 承認済みの応募のみチャットルームとして表示
- ✅ **実装済み**: 相手の情報を正しく取得

### 4. 検索・フィルタ関連

#### 4.1 検索パラメータのエッジケース
- ✅ **実装済み**: 空の検索キーワードの処理
- ✅ **実装済み**: 複数のフィルタの組み合わせ
- ✅ **実装済み**: 日付範囲のバリデーション
- ⚠️ **確認が必要**: 非常に長い検索キーワードの処理

#### 4.2 無限スクロールのエッジケース
- ✅ **実装済み**: 検索パラメータ変更時のリセット
- ✅ **実装済み**: すべての投稿を読み込み終わった場合の表示
- ✅ **実装済み**: エラー時の再試行機能

### 5. ユーザー関連

#### 5.1 プロフィールのエッジケース
- ✅ **実装済み**: 空の名前のチェック
- ✅ **実装済み**: 文字数制限のチェック
- ✅ **実装済み**: オンボーディング時のプロフィール設定

#### 5.2 認証のエッジケース
- ✅ **実装済み**: 未認証ユーザーのリダイレクト
- ✅ **実装済み**: プロフィール未設定ユーザーのリダイレクト
- ⚠️ **確認が必要**: セッションタイムアウト時の処理

---

## 潜在的なバグと修正

### 1. 日付のタイムゾーン問題

**問題**: 現在、日付の比較でサーバーのタイムゾーンを使用しているが、クライアントのタイムゾーンと異なる場合に問題が発生する可能性がある。

**推奨事項**:
- UTCで日付を保存・比較する
- 表示時にクライアントのタイムゾーンに変換する

**現状**: 現在の実装では問題が発生していないが、将来的に改善を検討

### 2. 並行更新の問題

**問題**: 複数のユーザーが同時に応募を承認した場合、参加者数が正しく更新されない可能性がある。

**推奨事項**:
- データベーストランザクションを使用
- 楽観的ロックを実装（将来実装）

**現状**: 現在の実装では問題が発生していないが、高トラフィック時には注意が必要

### 3. 無限スクロールのメモリリーク

**問題**: 大量の投稿を読み込んだ場合、メモリ使用量が増加する可能性がある。

**推奨事項**:
- 仮想スクロールを実装（将来実装）
- 古い投稿をメモリから削除

**現状**: 現在の実装では問題が発生していないが、将来的に改善を検討

### 4. 検索パラメータのURL長制限

**問題**: 大量のタグを選択した場合、URLが長くなりすぎる可能性がある。

**推奨事項**:
- URLパラメータの代わりにセッションストレージを使用（将来実装）
- タグの選択数を制限

**現状**: 現在の実装では問題が発生していないが、将来的に改善を検討

### 5. 画像URLの検証

**問題**: 現在、アバターURLの検証を行っていないため、不正なURLが設定される可能性がある。

**推奨事項**:
- URLの形式を検証
- 画像の存在確認（将来実装）

**現状**: 現在の実装では問題が発生していないが、将来的に改善を検討

### 6. Google OAuthのWebView制限

**問題**: モバイルブラウザのWebView（アプリ内ブラウザ）からGoogle OAuthでサインインしようとすると、`403: disallowed_useragent`エラーが発生する。

**原因**: Google OAuthはセキュリティ上の理由から、WebView（アプリ内ブラウザ）での認証を許可していない。

**対処方法**:
- ✅ **実装済み**: WebViewを検出し、ユーザーに外部ブラウザで開くよう促す警告を表示
- ✅ **実装済み**: `components/auth/webview-warning.tsx` コンポーネントを作成
- ✅ **実装済み**: ログイン・新規登録ページに警告を追加

**ユーザーへの案内**:
- iOS: 右上の「...」→「Safariで開く」
- Android: 右上の「...」→「Chromeで開く」または「ブラウザで開く」

**参考**: 
- [Clerk公式ドキュメント - Google OAuth](https://clerk.com/docs/authentication/social-connections/google)
- [Google OAuth セキュリティポリシー](https://developers.google.com/identity/protocols/oauth2/policies)

---

## 修正済みのバグ

### 1. 環境変数の読み込み問題
- ✅ **修正済み**: `drizzle.config.ts` と `lib/db/seed.ts` で環境変数の読み込みを修正

### 2. ミドルウェアの配置問題
- ✅ **修正済み**: `middleware.ts` をプロジェクトルートに移動

### 3. 型エラー
- ✅ **修正済み**: すべての型エラーを修正
- ✅ **修正済み**: `ApplicationWithPostAndApplicant` の型定義を修正

### 4. タグのN+1クエリ問題
- ✅ **修正済み**: `getTagsByPostIds` で一括取得を実装

### 5. Google OAuthのWebView制限問題
- ✅ **修正済み**: WebView検出と警告表示を実装
- ✅ **修正済み**: ログイン・新規登録ページに警告を追加

---

## テスト推奨事項

### 1. 手動テスト
- すべての主要な機能を手動でテスト
- エッジケースを確認
- 異なるブラウザでテスト

### 2. 自動テスト（将来実装）
- ユニットテスト: バリデーション関数、フォーマット関数
- 統合テスト: Server Actions
- E2Eテスト: 主要なユーザーフロー

### 3. パフォーマンステスト
- Lighthouseでパフォーマンススコアを確認
- 大量のデータでの動作確認

### 4. セキュリティテスト
- 認証・認可のテスト
- 入力バリデーションのテスト
- XSS、SQLインジェクションのテスト

---

## 既知の問題（将来修正）

### 1. レート制限の未実装
- 現在、APIレート制限を実装していない
- 本番環境では実装を推奨

### 2. エラーログの未実装
- 現在、エラーログを記録していない
- 本番環境では実装を推奨

### 3. 監査ログの未実装
- 現在、監査ログを記録していない
- 本番環境では実装を推奨
