# セキュリティチェックリスト

## 1. 認証チェック

### ✅ 実装済み
- [x] すべてのServer Actionで認証チェックを実装
- [x] `getCurrentUser()` または `ensureAuthenticated()` を使用
- [x] 未認証ユーザーは適切なエラーメッセージを返す

### 確認項目
- [ ] すべてのServer Actionで認証チェックが実装されている
- [ ] 認証チェックが最初に実行される（パフォーマンス最適化）
- [ ] 認証エラーメッセージが適切に返される

---

## 2. 認可チェック

### ✅ 実装済み
- [x] 投稿の編集・削除は投稿者のみ可能
- [x] 応募の承認/却下は投稿者のみ可能
- [x] チャットメッセージは承認済みの応募のみ可能

### 確認項目
- [ ] 投稿の編集・削除で投稿者チェックが実装されている
- [ ] 応募の承認/却下で投稿者チェックが実装されている
- [ ] チャットメッセージで応募の承認状態チェックが実装されている
- [ ] 他人のデータにアクセスできない

---

## 3. 入力バリデーション

### ✅ 実装済み
- [x] サーバー側でバリデーションを実行
- [x] 文字数制限のチェック
- [x] 数値範囲のチェック
- [x] 日付のバリデーション

### 確認項目
- [ ] すべての入力がサーバー側でバリデーションされる
- [ ] クライアント側のバリデーションは補助的なもの（セキュリティではない）
- [ ] 不正なデータが拒否される
- [ ] エラーメッセージが適切に返される

---

## 4. SQLインジェクション対策

### ✅ 実装済み
- [x] Drizzle ORMを使用（パラメータ化クエリ）
- [x] 生のSQLクエリを使用していない

### 確認項目
- [ ] すべてのデータベースクエリでDrizzle ORMを使用
- [ ] 生のSQLクエリや文字列連結を使用していない
- [ ] ユーザー入力が直接SQLに埋め込まれていない

---

## 5. XSS対策

### ✅ 実装済み
- [x] Reactのデフォルトエスケープを使用
- [x] `dangerouslySetInnerHTML` を使用していない

### 確認項目
- [ ] すべてのユーザー入力がReactで自動エスケープされる
- [ ] `dangerouslySetInnerHTML` を使用していない
- [ ] マークダウン表示が必要な場合は適切なライブラリを使用（将来実装）

---

## 6. CSRF対策

### ✅ 実装済み
- [x] Next.js Server Actionsは自動的にCSRF対策を実装
- [x] フォームでServer Actionsを使用

### 確認項目
- [ ] すべてのフォームでServer Actionsを使用
- [ ] カスタムAPIルートを使用していない（必要に応じてCSRFトークンを実装）

---

## 7. レート制限

### ⚠️ 未実装（将来実装）
- [ ] APIレート制限の実装
- [ ] スパム対策

### 推奨事項
- 本番環境ではレート制限を実装することを推奨
- VercelやCloudflareなどのプラットフォームのレート制限機能を活用

---

## 8. 環境変数の管理

### ✅ 実装済み
- [x] 機密情報を環境変数に保存
- [x] `.env.local` を `.gitignore` に追加

### 確認項目
- [ ] 機密情報（APIキー、トークン）が環境変数に保存されている
- [ ] `.env.local` が `.gitignore` に追加されている
- [ ] `.env.local.example` に機密情報が含まれていない

---

## 9. エラーハンドリング

### ✅ 実装済み
- [x] エラーメッセージに機密情報が含まれていない
- [x] 適切なエラーメッセージを返す

### 確認項目
- [ ] エラーメッセージに機密情報（データベース構造、内部実装）が含まれていない
- [ ] ユーザーフレンドリーなエラーメッセージを返す
- [ ] 詳細なエラー情報はサーバーログに記録される

---

## 10. データアクセス制御

### ✅ 実装済み
- [x] ユーザーは自分のデータのみアクセス可能
- [x] 投稿者は自分の投稿の応募のみ承認/却下可能

### 確認項目
- [ ] ユーザーは自分のプロフィールのみ編集可能
- [ ] ユーザーは自分の投稿のみ編集・削除可能
- [ ] ユーザーは自分の応募のみキャンセル可能
- [ ] 投稿者は自分の投稿の応募のみ承認/却下可能
- [ ] チャットメッセージは承認済みの応募の関係者のみ送信可能

---

## 11. セッション管理

### ✅ 実装済み
- [x] Clerkがセッション管理を担当
- [x] セッションタイムアウトが適切に設定されている

### 確認項目
- [ ] Clerkのセッション設定が適切
- [ ] セッションタイムアウトが適切に設定されている
- [ ] ログアウト機能が動作する（将来実装）

---

## 12. ファイルアップロード（将来実装）

### ⚠️ 未実装
- [ ] ファイルタイプの検証
- [ ] ファイルサイズの制限
- [ ] ウイルススキャン（将来実装）

### 推奨事項
- ファイルアップロードを実装する場合は、適切な検証と制限を実装
- 画像のみ許可する場合は、MIMEタイプとファイル拡張子を検証
- ファイルサイズを制限（例: 5MB以下）

---

## 13. パスワードポリシー（Clerkが管理）

### ✅ 実装済み
- [x] Clerkがパスワードポリシーを管理
- [x] パスワードリセット機能（Clerkが提供）

### 確認項目
- [ ] Clerkのパスワードポリシーが適切に設定されている
- [ ] パスワードリセット機能が動作する

---

## 14. ログと監査

### ⚠️ 未実装（将来実装）
- [ ] 重要な操作のログ記録
- [ ] 監査ログの実装

### 推奨事項
- 本番環境では重要な操作（投稿作成、応募承認など）をログに記録
- 監査ログを実装して、セキュリティインシデントを追跡

---

## 15. 依存関係のセキュリティ

### 確認項目
- [ ] 定期的に依存関係を更新
- [ ] 既知の脆弱性がないか確認（`npm audit`）
- [ ] セキュリティパッチを適用

### 推奨事項
```bash
# 依存関係の脆弱性を確認
npm audit

# 自動修正可能な脆弱性を修正
npm audit fix
```
